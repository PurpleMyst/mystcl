#!/usr/bin/env bash

git clone --no-checkout https://github.com/Akuli/teek || exit 1
git -C teek checkout f0acc49 || exit 1
sed -i s/teek._ctypes_tcl/mystcl/g teek/teek/_tcl_calls.py || exit 1

for PYBIN in /opt/python/{cp35-cp35m,cp36-cp36m,cp37-cp37m}/bin; do
    export PYTHON_SYS_EXECUTABLE="$PYBIN/python"

    "${PYBIN}/pip" pip install \
        pytest \
        docutils sphinx \
        pillow reportlab svglib lxml beautifulsoup4 || exit 1

    ( pushd teek && "${PYBIN/python}" -m pytest && popd ) || exit 1
done
